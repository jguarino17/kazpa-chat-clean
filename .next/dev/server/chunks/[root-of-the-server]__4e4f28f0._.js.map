{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/joey/kazpagpt/app/api/chat/route.ts"],"sourcesContent":["import OpenAI from \"openai\";\nimport { NextResponse } from \"next/server\";\n\n// Optional if you’re using your knowledge functions later:\n// import { getCanonBundle, retrieveKnowledge } from \"@/lib/knowledge\";\n\nconst client = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\nfunction wantsDeepDetail(text: string) {\n  const t = text.toLowerCase();\n  return (\n    t.includes(\"step by step\") ||\n    t.includes(\"walk me through\") ||\n    t.includes(\"in detail\") ||\n    t.includes(\"detailed\") ||\n    t.includes(\"deep\") ||\n    t.includes(\"explain more\") ||\n    t.includes(\"full explanation\") ||\n    t.includes(\"troubleshoot\") ||\n    t.includes(\"debug\") ||\n    t.includes(\"every step\") ||\n    t.length > 160\n  );\n}\n\nfunction enforceVerbosity(reply: string, userMessage: string) {\n  // If they asked for deep detail, don’t clamp hard.\n  if (wantsDeepDetail(userMessage)) return reply.trim();\n\n  // Hard limiter: keep it tight and chat-friendly\n  // Target: max ~12 lines, and trim excess paragraphs.\n  const lines = reply\n    .replace(/\\r\\n/g, \"\\n\")\n    .split(\"\\n\")\n    .map((l) => l.trimEnd());\n\n  // Remove excessive blank lines\n  const cleaned: string[] = [];\n  for (const line of lines) {\n    if (line.trim() === \"\" && cleaned[cleaned.length - 1]?.trim() === \"\") continue;\n    cleaned.push(line);\n  }\n\n  // Limit lines\n  const maxLines = 12;\n  let out = cleaned.slice(0, maxLines).join(\"\\n\").trim();\n\n  // If we truncated, add a soft continuation cue (but not a second question)\n  if (cleaned.length > maxLines) {\n    out = out.replace(/\\n+$/g, \"\");\n    out += \"\\n\\nIf you want, tell me what you see on your screen and I’ll guide the next step.\";\n  }\n\n  // Avoid ending with dangling colon\n  out = out.replace(/:\\s*$/g, \".\");\n\n  return out.trim();\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json().catch(() => ({}));\n    const message = String(body?.message ?? \"\").trim();\n\n    if (!message) {\n      return NextResponse.json({ reply: \"Ask a question and I’ll help.\" });\n    }\n\n    const system = `\nYou are kazpaGPT — the official AI educator, qualifier, and support assistant for kazpa.io.\n\nIDENTITY & ROLE\n- Educate users clearly and honestly about kazpa\n- Help with setup, troubleshooting, FAQs, and next steps\n- Qualify fit when appropriate (max 3 questions total)\n- Guide aligned users to apply at https://kazpa.io/apply (only after educating + confirming fit)\n\nNON-NEGOTIABLE BRAND RULES\n- Always write “kazpa” in lowercase\n- MT5 only (never MT4)\n- Never use: bot, bots, signals, guaranteed, easy money, passive income, get rich quick\n- Use: software, system, trading software, automation, execution software\n- Tone: calm, confident, precise, professional\n- No emojis, no hype\n\nCORE TRUTH\n- kazpa licenses trading software only\n- kazpa does NOT manage funds\n- kazpa does NOT provide financial or investment advice\n- Users control broker, capital, risk settings, and when software runs\n- Trading is high risk and losses are possible\n- Past performance does not guarantee future results\n\nPRODUCT (CANONICAL)\nVistaONE\n- Trades: EURUSD on M15\n- Purpose: long-term, compounding-style automation\n- Risk: low to moderate (still drawdown)\n- Usage: runs 24/5 with monitoring\n\nVistaX\n- Trades: XAUUSD on M5\n- Purpose: session-based execution\n- Risk: moderate to high\n- Usage: user-controlled windows (example: 1–2 hours)\n- Never position VistaX as beginner-friendly\n- If unsure, recommend VistaONE first\n\nAUTOTRADING RULES (MT5)\n- AutoTrading must be ON (green) for the software to execute\n- Turning AutoTrading OFF is a valid risk-control action\n- Suggest OFF during major news, low-liquidity holidays, platform updates, or set/input changes\n\nHONESTY\n- Never invent features, pricing, results, or policies\n- If not confirmed, say so and ask 1–2 clarifying questions or direct to support\n\nSECURITY\n- Never ask for passwords, API keys, broker credentials, or license keys\n- Account-specific licensing/billing/DFY issues -> official kazpa support\n\nCANONICAL RESPONSE PATTERN (DEFAULT)\n- Start with a direct answer in 1–2 short lines.\n- Then add \"Key points:\" with 3–5 bullets max (no nested bullets).\n- End with exactly ONE of:\n  (a) one clarifying question, OR\n  (b) one concrete next step.\n- Do NOT reset the conversation with generic \"How can I help?\" follow-ups.\n- If the user replies with \"sure / yes / ok / do it\" after you offered steps, continue with those steps immediately.\n- Keep it tight unless the user explicitly asks for deep detail.\n`.trim();\n\n    const deep = wantsDeepDetail(message);\n\n    const resp = await client.responses.create({\n      model: \"gpt-4.1-mini\",\n      input: [\n        { role: \"system\", content: system },\n        { role: \"user\", content: message },\n      ],\n      temperature: 0.3,\n      max_output_tokens: deep ? 900 : 350,\n    });\n\n    const raw =\n      (resp.output_text && resp.output_text.trim()) ||\n      \"I couldn’t generate a reply. Try again.\";\n\n    const reply = enforceVerbosity(raw, message);\n\n    return NextResponse.json({ reply });\n  } catch (err: any) {\n    console.log(\"OPENAI ERROR:\", err?.message || err);\n    console.log(\"OPENAI ERROR DETAILS:\", err?.response?.data || err);\n\n    return NextResponse.json(\n      { reply: \"AI connection error. Check Terminal for the exact error (OPENAI ERROR).\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEA,2DAA2D;AAC3D,uEAAuE;AAEvE,MAAM,SAAS,IAAI,mLAAM,CAAC;IACxB,QAAQ,QAAQ,GAAG,CAAC,cAAc;AACpC;AAEA,SAAS,gBAAgB,IAAY;IACnC,MAAM,IAAI,KAAK,WAAW;IAC1B,OACE,EAAE,QAAQ,CAAC,mBACX,EAAE,QAAQ,CAAC,sBACX,EAAE,QAAQ,CAAC,gBACX,EAAE,QAAQ,CAAC,eACX,EAAE,QAAQ,CAAC,WACX,EAAE,QAAQ,CAAC,mBACX,EAAE,QAAQ,CAAC,uBACX,EAAE,QAAQ,CAAC,mBACX,EAAE,QAAQ,CAAC,YACX,EAAE,QAAQ,CAAC,iBACX,EAAE,MAAM,GAAG;AAEf;AAEA,SAAS,iBAAiB,KAAa,EAAE,WAAmB;IAC1D,mDAAmD;IACnD,IAAI,gBAAgB,cAAc,OAAO,MAAM,IAAI;IAEnD,gDAAgD;IAChD,qDAAqD;IACrD,MAAM,QAAQ,MACX,OAAO,CAAC,SAAS,MACjB,KAAK,CAAC,MACN,GAAG,CAAC,CAAC,IAAM,EAAE,OAAO;IAEvB,+BAA+B;IAC/B,MAAM,UAAoB,EAAE;IAC5B,KAAK,MAAM,QAAQ,MAAO;QACxB,IAAI,KAAK,IAAI,OAAO,MAAM,OAAO,CAAC,QAAQ,MAAM,GAAG,EAAE,EAAE,WAAW,IAAI;QACtE,QAAQ,IAAI,CAAC;IACf;IAEA,cAAc;IACd,MAAM,WAAW;IACjB,IAAI,MAAM,QAAQ,KAAK,CAAC,GAAG,UAAU,IAAI,CAAC,MAAM,IAAI;IAEpD,2EAA2E;IAC3E,IAAI,QAAQ,MAAM,GAAG,UAAU;QAC7B,MAAM,IAAI,OAAO,CAAC,SAAS;QAC3B,OAAO;IACT;IAEA,mCAAmC;IACnC,MAAM,IAAI,OAAO,CAAC,UAAU;IAE5B,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,UAAU,OAAO,MAAM,WAAW,IAAI,IAAI;QAEhD,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgC;QACpE;QAEA,MAAM,SAAS,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AA8DpB,CAAC,CAAC,IAAI;QAEF,MAAM,OAAO,gBAAgB;QAE7B,MAAM,OAAO,MAAM,OAAO,SAAS,CAAC,MAAM,CAAC;YACzC,OAAO;YACP,OAAO;gBACL;oBAAE,MAAM;oBAAU,SAAS;gBAAO;gBAClC;oBAAE,MAAM;oBAAQ,SAAS;gBAAQ;aAClC;YACD,aAAa;YACb,mBAAmB,OAAO,MAAM;QAClC;QAEA,MAAM,MACJ,AAAC,KAAK,WAAW,IAAI,KAAK,WAAW,CAAC,IAAI,MAC1C;QAEF,MAAM,QAAQ,iBAAiB,KAAK;QAEpC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE;QAAM;IACnC,EAAE,OAAO,KAAU;QACjB,QAAQ,GAAG,CAAC,iBAAiB,KAAK,WAAW;QAC7C,QAAQ,GAAG,CAAC,yBAAyB,KAAK,UAAU,QAAQ;QAE5D,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA0E,GACnF;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}